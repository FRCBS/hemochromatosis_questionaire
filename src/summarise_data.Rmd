---
title: "Summary of hemochromatosis questionnaire answers"
author: "Elina Koskinen, Jonna Clancy and Mikko Arvas"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    theme: united
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(gtsummary)
library(likert)
library(readxl)
library(here)
library(responsesR)

```


TODO:

-viimeistele kuvat (värit, raja-arvot, kaikki merkit näkyy)

-kumpi kieli: ENG

-dokumentin rakenne, onko kysymykset oikeassa järjestyksessä: nyt on numerojärjestyksessä

-kun nämä valmiina niin kuvailevaa tekstiä, mitä kuvassa nähdään? vastaako oletuksia? onko jotain poikkevaa? onko jotain terveydellistä merkitystä? -nämä kommentit työpäiväkirjassa


# Data

## Import

```{r}
file <- here("data/Tulokset - hemokromatoosikysely vastaukset (ID 133620).xlsx")
data <- read_xlsx(file)

colnames(data)
```

```{r}
#remove open questions
data<- data %>% 
  select(
    -Kys8aFutureOpen,
    -Kys12aTrustOpen,
    -Kys13aMembertoBiobankOpen,
    -Kys15OtherWhere,
    -Kys21OtherResultsOpen,
    -Kys23SymptomsOpen,
    -Kys26cAttitudesinFamilyOpen
    
  )
summary(data)
```

 

## Process

```{r}

data <-  data %>% 
  rename(Kys20aBHFED = `Kys20aB-HFE-D`) %>% 
  mutate(
    Kys2Gender = factor(Kys2Gender),
    Kys3DonationCount = factor(Kys3DonationCount,ordered = TRUE),
    Kys9Useful = factor(
      Kys9Useful,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    Kys10Worry = factor(
      Kys10Worry,
      ordered = TRUE,
      #First you specify the levels in the original data , in the order that you want them to be
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      #Then you specify new names for them
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
      # > tmp$Kys10Worry
      #...
      # Levels: Totally agree < Partly agree < Neutral < Partly disagree < Totally disagree
      #> table(tmp$Kys10Worry)
      # 
      # Totally agree     Partly agree          Neutral  Partly disagree Totally disagree 
      # 3               12                0               10                5
    ),
    
    
    Kys11HealthPromotion = factor(
      Kys11HealthPromotion,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    
    Kys16Flexibility = factor(
      Kys16Flexibility,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    
    Kys17Support = factor(
      Kys17Support,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    
    Kys18Answers = factor(
      Kys18Answers,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    
    Kys24Influence = factor(
      Kys24Influence,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    
    Kys25Motivation = factor(
      Kys25Motivation,
      ordered = TRUE,
      levels = rev(c("Strongly agree","Partly agree","Neither agree nor disagree","Partly disagree","Strongly disagree")),
      labels =  rev(c("Totally agree","Partly agree","Neutral","Partly disagree","Totally disagree"))
    ),
    
    Kys5HowOften = factor(
      Kys5HowOften,
      ordered = FALSE,
      levels = rev(c("More often than nowadays", "As per nowadays", "Less than nowadays", "Quitting donating blood because of the information received", "Quitting donating blood because of another reason, eg. Age or other barrier", "Can not tell"))
    ),
    
    Kys6EasytoUnderstand = factor(
      Kys6EasytoUnderstand,
      ordered = TRUE,
      levels = c("No", "Can not tell", "Yes")
    ),
    
    Kys7Understanding = factor(
      Kys7Understanding,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys8Future = factor(
      Kys8Future,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys12Trust = factor(
      Kys12Trust,
      ordered = TRUE,
      levels = rev(c("Grown", "Partly grown", "Have not affected", "Partly decreased", "Decreased"))
    ),
    
    Kys13MembertoBiobank = factor(
      Kys13MembertoBiobank,
      ordered = TRUE,
      levels = rev(c("Grown", "Partly grown", "Have not affected", "Partly decreased", "Decreased"))
    ),
    
    Kys14Healthcare = factor(
      Kys14Healthcare,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys15aStudentHealth = factor(
      Kys15aStudentHealth,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys15bOccupational = factor(
      Kys15bOccupational,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys15cSpecialHealth = factor(
      Kys15cSpecialHealth,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys15dHealthCare = factor(
      Kys15dHealthCare,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys15ePrivate = factor(
      Kys15ePrivate,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    
    Kys19Attitude = factor(
      Kys19Attitude,
      ordered = TRUE,
      levels = rev(c("Positive", "Partly positive", "Neutral", "Partly negative", "Negative"))
    ),
    
    Kys22Diagnosis = factor(
      Kys22Diagnosis,
      ordered = FALSE,
      levels = c("Yes", "No", "Don't know")
    ),
    
    Kys23aTiredness = factor(
      Kys23aTiredness,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys23bJoint = factor(
      Kys23bJoint,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys23cType2DM = factor(
      Kys23cType2DM,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys26aFamily = factor(
      Kys26aFamily,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    
    Kys1Age	= as.numeric(Kys1Age),
    Kys4YearStarted = as.numeric(Kys4YearStarted),
    Kys20aBHFED = factor(
    Kys20aBHFED,
      ordered = FALSE,
      levels = c("Yes", "No")
    ),
    Kys20bFerrit = as.numeric(Kys20bFerrit),
    Kys20cTrfesat = as.numeric(Kys20cTrfesat),
    Kys20dHemoglobin = as.numeric(Kys20dHemoglobin),
    Kys20eMCV = as.numeric(Kys20eMCV),
    Kys20fALAT = as.numeric(Kys20fALAT),
    Kys26bNumberofRelatives = as.numeric(Kys26bNumberofRelatives)
  )

summary(data)
```



# Demographics



## Demographics Table 1

```{r}

table1 <-
  tbl_summary(
    data %>% rename(
      Age =  Kys1Age,
      YearStarted = Kys4YearStarted,
      DonationCount = Kys3DonationCount
    ),
    include = c(
      Age,
      YearStarted,  
      DonationCount
      ),
    by =  Kys2Gender
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1

```



## Age by Gender


```{r}

p <- ggplot(data)
p <- p +  geom_histogram(aes(x=Kys1Age),binwidth = 5)
p <- p + facet_wrap(. ~ Kys2Gender)
p <- p + xlab("Age in years")
p

ggsave(plot = p,filename = "../results/age.png", dpi = 600,width =  160, height = 80,units = "mm")


```



=======
# Likert scales
```{r} 
items = data %>% 
  select(Kys5HowOften) %>% as.data.frame()
colnames(items) <- c(
  "After receiving genetic information about hemochromatosis, how are you planning to continue to donate?"
)

nlevels = 6
```

```{r}
q09 <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(q09, 
     type = "bar",
     wrap = 20,
     #legend.position = c(0.3, 0.7),
     legend.position = c("bottom"),
     legend = element_blank(),
     #likert.options = 
     text.size=2.5,
     include.histogram = FALSE) 

#tässä ei voi siirtää vastausvaihtoehtona vasemmalle ilman että voisi rivittää pitkiä vastausvaihtoehtoja
```
# Table of Questions 6, 7, 8
```{r}

table1 <-
  tbl_summary(
    data %>% rename(
      EasytoUnderstand = Kys6EasytoUnderstand,
      Understanding =  Kys7Understanding,
      Future = Kys8Future
    ),
    include = c(
      EasytoUnderstand,
      Understanding,
      Future
      ),
    #by =  Kys2Gender
    #sukupuolittain vai ei?
    
    #Kys 6 Minulle palautettu geenitieto oli helppo ymmärtää
    #onko tämä kysymys 6 järkevä tänne, vastausvaihtoehto oli myös EOS
    #Kys 7 Ymmärsitkö biopankkisuostumusta antaessasi, että se voisi oikeasti johtaa terveydelle merkityksellisen tiedon vastaanottamiseen?
    #Kys 8 Toivoisitko saavasi vastaavaa tietoa tulevaisuudessa, mikäli sellaista ilmenisi?
    #nämä kuvina?
    
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1

```
#Questions 9, 10, 11

```{r} 
items = data %>% 
  select(Kys9Useful, Kys10Worry, Kys11HealthPromotion) %>% as.data.frame()
colnames(items) <- c(
  "It was useful to receive genetic information",
  "Receiving genetic information did not worry me",
  "The genetic information in biobank should be made use of more to prevent health"
)

nlevels = 5
```

```{r}
q09 <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(q09, 
     type = "bar",
     wrap = 20,
     #legend.position = c(0.3, 0.7),
     legend.position = c("bottom"),
     legend = element_blank(),
     #likert.options = 
     text.size=2.5,
     include.histogram = FALSE) 
```


```{r}
png(filename = "../results/q09.png",
    units = "mm",
    width =  180, 
    height = 80,
    res=600
    )
plot(q09, 
     type = "bar",
     wrap = 20,
     #legend.position = c(0.3, 0.7),
     legend.position = c("bottom"),
     legend = element_blank(),
     #likert.options = 
     text.size=2.5,
     include.histogram = FALSE) 
dev.off()

```



=======
#Questions 12, 13
```{r} 
items = data %>% 
  select(Kys12Trust, Kys13MembertoBiobank) %>% as.data.frame()
colnames(items) <- c(
  "How has receiving genetic information affected to your confidence in Blood Service?",
  "How has receiving genetic information affected to your willingness to belong to Blood Service Biobank?"
)

nlevels = 5
```

```{r}
q09 <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(q09, 
     type = "bar",
     wrap = 27,
     legend.position = "left",
     legend = element_blank(),
     text.size=2,
     include.histogram = FALSE)
```
Table of Q 14, 15

```{r}

table1 <-
  tbl_summary(
    data %>% rename(
      ApplyingHealthCare =  Kys14Healthcare,
      StudentHealth = Kys15aStudentHealth,
      OccupationalHealth = Kys15bOccupational,
      SpecialHealth = Kys15cSpecialHealth,
      HealthCareCenter = Kys15dHealthCare,
      Private = Kys15ePrivate
    ),
    include = c(
      ApplyingHealthCare,
      StudentHealth,  
      OccupationalHealth,
      SpecialHealth,
      HealthCareCenter,
      Private
      ),
    #by =  Kys2Gender
    
    #14) Hakeuduitko tiedon saatuasi terveydenhuollon palveluihin?
    #15) minne
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1
```
#Questions 16, 17, 18
```{r} 
items = data %>% 
  select(Kys16Flexibility, Kys17Support, Kys18Answers) %>% as.data.frame()
colnames(items) <- c(
  "My situation was taken care of fluently in health care",
  "I got enough support from health care",
  "My questions were answered in health care"
)

nlevels = 5
```

```{r}
q09 <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(q09, 
     type = "bar",
     wrap = 15,
     legend.position = "bottom",
     legend = element_blank(),
     text.size=2.5,
     include.histogram = FALSE)
```
#Question 19

```{r} 
items = data %>% 
  select(Kys19Attitude) %>% as.data.frame()
colnames(items) <- c(
  "In health care services, the attitude towards the returned information from Biobank was…"
)

nlevels = 5
```
```{r}
q09 <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(q09, 
     type = "bar",
     wrap = 15,
     legend.position = "bottom",
     legend = element_blank(),
     text.size=2.5,
     include.histogram = FALSE)
```
#Question 22
```{r}

table1 <-
  tbl_summary(
    data %>% rename(
      Diagnosis = Kys22Diagnosis
    ),
    include = c(
      Diagnosis
      ),
    by =  Kys2Gender
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1
```
#Question 23
```{r}

table1 <-
  tbl_summary(
    data %>% rename(
      Tiredness =  Kys23aTiredness,
      JointPain = Kys23bJoint,
      Type2DM = Kys23cType2DM
    ),
    include = c(
      Tiredness,
      JointPain,  
      Type2DM
      ),
    by =  Kys2Gender
    #sukupuolittain vai ei?
    
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1
```
#Questions 24, 25
```{r} 
items = data %>% 
  select(Kys24Influence, Kys25Motivation) %>% as.data.frame()
colnames(items) <- c(
  "I believe I can make an impact with my lifestyle to my predisposition to hemochromatosis",
  "Receiving genetic information motivates me to take care of my health better"
)


nlevels = 5
```


```{r}
q09 <- likert(
  items = as.data.frame(items),
  nlevels = nlevels
  
)
plot(q09, 
     type = "bar",
     wrap = 20,
     legend.position = "bottom",
     legend = element_blank(),
     text.size=2.5,
     include.histogram = FALSE)

```
#Question 26
```{r}

table1 <-
  tbl_summary(
    data %>% rename(
      Relatives = Kys26aFamily,
      NumberofRelatives = Kys26bNumberofRelatives
    ),
    include = c(
      Relatives,
      NumberofRelatives
      ),
    #by =  Kys2Gender
    
  ) %>%
  add_n()  # add column with total number of non-missing observations
table1


```



# Distributions of lab values by gender

add here like age


```{r}

p <- ggplot(data)
p <- p + geom_histogram(aes(x=Kys20bFerrit), binwidth = 10)
p <- p + facet_wrap(. ~ Kys2Gender,scales = "free")
p <- p + xlab("Ferritin µg/l")
#p <- p + scale_x_log10() + geom_vline(aes(xintercept = 15, col = "red")) + geom_vline(aes(xintercept = 1000, col = "red"))
p <- p  + geom_vline(aes(xintercept = 15), col = "red") #+ geom_vline(aes(xintercept = 1000), col = "red")
p

```   


```{r}

p <- ggplot(data)
p <- p + geom_histogram(aes(x=Kys20cTrfesat), binwidth = 0.2)
p <- p + facet_wrap(. ~ Kys2Gender)
p <- p + xlab("Transferrin saturation %")
p <- p + geom_vline(aes(xintercept = 15, col = "red")) + geom_vline(aes(xintercept = 50, col = "red"))
#samat viitevälit

p


```  
```{r}

p <- ggplot(data)
p <- p + geom_histogram(aes(x=Kys20dHemoglobin), binwidth = 5)
p <- p + facet_wrap(. ~ Kys2Gender)
p <- p + xlab("Hemoglobin g/l") + xlim(120,180)
#p <- p + scale_x_log10() + geom_vline(aes(xintercept = 15, col = "red")) + geom_vline(aes(xintercept = 100, col = "red"))
#alaraja 120, yläraja 180 huomioitu, miten viiterajat, eri sukupuolittain?
p


```  
```{r}

p <- ggplot(data)
p <- p + geom_histogram(aes(x=Kys20eMCV), binwidth = 2)
p <- p + facet_wrap(. ~ Kys2Gender)
p <- p + xlab("e-MCV fl") + xlim(70,110)
#p <- p + scale_x_log10() + geom_vline(aes(xintercept = 82, col = "red")) + geom_vline(aes(xintercept = 98, col = "red"))
p <- p  + geom_vline(aes(xintercept = 82, col = "red")) + geom_vline(aes(xintercept = 98, col = "red"))
p

#Samat viitevälit miehet&naiset. yläraja&alaraja huomioitu, yksi hassu arvo putoaa pois

``` 
```{r}

#tässä eri viiterajat miehet alle 50 / naiset alle 35
limits <- tibble(Kys2Gender = c("Male","Female"),Kys20fALAT=c(50,35))

p <- ggplot(data)
p <- p + geom_histogram(aes(x=Kys20fALAT), binwidth = 5)
p <- p + facet_wrap(. ~ Kys2Gender)
p <- p + xlab("P-ALAT U/l")
p <-  p + geom_vline(data=limits,aes(xintercept= Kys20fALAT), col="red")
#p <- p + geom_vline(aes(xintercept = 15, col = "red")) + geom_vline(aes(xintercept = 50, col = "red"))


p

``` 

# Disributions of Yes/No questions

```{r}

p <- ggplot(data)
p <- p + geom_bar(aes(x=Kys6EasytoUnderstand))
p <- p + xlab("The received genetic information was easy to understand.")
p <- p + theme(plot.margin = unit(c(1,2,1,2),"cm"))
p

#Toimiiko tämä tässä, kun Kyllä/Ei/EOS vaihtoehdot

```
```{r}

p <- ggplot(data)
p <- p + geom_bar(aes(x=Kys7Understanding))
p <- p + xlab("When you gave your consent for biobank,\ndid you understand it could lead to\nreceiving information relevant to your health?")
p <- p + theme(plot.margin = unit(c(1,2,1,2),"cm"))

p

```
```{r}

p <- ggplot(data)
p <- p + geom_bar(aes(x=Kys8Future))
p <- p + xlab("Would you like to receive similar information\nin the future, should it appear?")
p <- p + theme(plot.margin = unit(c(1,2,1,2),"cm"))
p

```
```{r}

p <- ggplot(data)
p <- p + geom_bar(aes(x=Kys14Healthcare))
p <- p + xlab("After receiving the information, did you apply for health care?")
p <- p + theme(plot.margin = unit(c(1,2,1,2),"cm"))
p

```

```{r}

p <- ggplot(data)
p <- p + geom_bar(aes(x=Kys22Diagnosis))
p <- p + xlab("Did you get a clinical diagnosis\nfor hemochromatosis (ICD10: E83.1)?")
p <- p + theme(plot.margin = unit(c(1,2,1,2),"cm"))
p

```

```{r}

p <- ggplot(data)
p <- p + geom_bar(aes(x=Kys26aFamily))
p <- p + xlab("I have discussed about my predisposition\nto hemochromatosis with my close relatives.")
p <- p + theme(plot.margin = unit(c(1,2,1,2),"cm"))
p


```
